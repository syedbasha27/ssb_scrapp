<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>SSB Scrap Collector</title>
    <!-- DYNAMIC VIEWPORT: forces correct mobile scale even in PWA/installed mode -->
    <meta name="viewport"
        content="width=device-width, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0, user-scalable=no, viewport-fit=cover">
    <script>
        // Detect environment and apply correct viewport immediately
        (function () {
            var ua = navigator.userAgent.toLowerCase();
            var isMobile = /android|iphone|ipad|ipod|windows phone|mobile/.test(ua);
            var isPWA = window.matchMedia('(display-mode: standalone)').matches ||
                window.navigator.standalone === true ||
                window.location.search.indexOf('source=pwa') !== -1;
            var v = document.querySelector('meta[name="viewport"]');
            if (v) {
                if (isMobile || isPWA) {
                    v.content = 'width=device-width, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0, user-scalable=no, viewport-fit=cover';
                    document.documentElement.style.zoom = '1';
                    document.documentElement.style.webkitTextSizeAdjust = '100%';
                    document.documentElement.style.textSizeAdjust = '100%';
                } else {
                    // Desktop browser: allow normal scaling
                    v.content = 'width=device-width, initial-scale=1.0';
                }
            }
        })();
    </script>
    <meta name="mobile-web-app-capable" content="yes">
    <link rel="manifest" href="./manifest.json">
    <meta name="theme-color" content="#1b4332">

    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="SSB Scrap">

    <link rel="apple-touch-icon" href="./logo.png">

    <style>
        /* ---------- RESET & BASE ---------- */
        *, *::before, *::after {
            box-sizing: border-box;
            -webkit-tap-highlight-color: transparent;
        }

        html {
            -webkit-text-size-adjust: 100%;
            text-size-adjust: 100%;
            /* Prevent font inflation on mobile */
        }

        body {
            margin: 0;
            font-family: 'Poppins', -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            background: #e0e5ec;
            color: #333;
            transition: background 0.3s ease;
            padding-bottom: env(safe-area-inset-bottom, 60px);
            /* PWA safe area */
            min-height: 100dvh;
            /* dynamic viewport height for mobile browsers */
            overflow-x: hidden;
        }

        /* PWA standalone: account for status bar */
        @media all and (display-mode: standalone) {
            body {
                padding-top: env(safe-area-inset-top, 0px);
            }
            header {
                padding-top: max(18px, env(safe-area-inset-top, 18px)) !important;
            }
        }

        .hidden {
            display: none !important;
        }

        /* ---------- PAGE LAYOUT ---------- */
        .page {
            display: none;
            padding: clamp(16px, 5vw, 40px) clamp(12px, 4vw, 20px);
            text-align: center;
            max-width: 860px;
            width: 100%;
            margin: 0 auto;
            animation: fadeIn 0.4s ease-in-out;
        }

        .active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to   { opacity: 1; transform: translateY(0);    }
        }

        /* ---------- TYPOGRAPHY (fluid) ---------- */
        h1 { font-size: clamp(22px, 5.5vw, 36px); margin-bottom: 8px; }
        h2 { font-size: clamp(19px, 4.5vw, 30px); }
        h3 { font-size: clamp(17px, 4vw, 23px); }
        p  { font-size: clamp(15px, 3vw, 18px); }

        /* ---------- BUTTONS ---------- */
        button {
            padding: clamp(10px, 2.5vw, 12px) clamp(18px, 4vw, 30px);
            background: linear-gradient(135deg, #2d6a4f, #1b4332);
            color: white;
            border: none;
            border-radius: 25px;
            cursor: pointer;
            margin-top: 20px;
            font-weight: 600;
            font-size: clamp(15px, 3vw, 17px);
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            transition: all 0.2s ease;
            touch-action: manipulation;
            /* Prevents 300ms delay on mobile */
            -webkit-user-select: none;
            user-select: none;
        }

        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(45, 106, 79, 0.3);
        }

        button:active {
            transform: translateY(0);
            opacity: 0.85;
        }

        /* ---------- INPUTS ---------- */
        input:not([type="checkbox"]),
        textarea,
        select {
            padding: clamp(9px, 2vw, 12px);
            width: min(280px, calc(100% - 20px));
            margin: 8px;
            border-radius: 8px;
            border: 1px solid #ddd;
            font-family: inherit;
            font-size: clamp(15px, 3vw, 17px);
            transition: border 0.2s, box-shadow 0.2s;
            outline: none;
            background: white;
            -webkit-appearance: none;
            appearance: none;
        }

        input[type="checkbox"] {
            width: 20px !important;
            height: 20px !important;
            margin: 5px !important;
            cursor: pointer !important;
            display: inline-block !important;
            opacity: 1 !important;
            visibility: visible !important;
            appearance: auto !important;
            -webkit-appearance: checkbox !important;
        }

        input:focus,
        textarea:focus,
        select:focus {
            border-color: #2d6a4f;
            box-shadow: 0 0 0 3px rgba(45, 106, 79, 0.12);
        }

        select {
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='8' viewBox='0 0 12 8'%3E%3Cpath fill='%23555' d='M0 0l6 8 6-8z'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 10px center;
            padding-right: 28px;
        }

        /* ---------- HEADER ---------- */
        header {
            background: linear-gradient(90deg, #1b4332, #2d6a4f);
            color: white;
            padding: 16px clamp(12px, 4vw, 40px);
            display: flex;
            justify-content: space-between;
            align-items: center;
            gap: 8px;
            flex-wrap: wrap;
            box-shadow: 0 4px 10px rgba(0, 0, 0, 0.15);
            position: sticky;
            top: 0;
            z-index: 100;
        }

        header h2 {
            margin: 0;
            font-weight: 700;
            cursor: pointer;
            letter-spacing: 0.5px;
            font-size: clamp(19px, 4.5vw, 26px);
        }

        header div {
            font-size: clamp(14px, 3vw, 16px);
            opacity: 0.9;
        }

        /* ---------- ALERT TICKER ---------- */
        .alertBar {
            background: #fab005;
            color: #222;
            font-weight: 600;
            overflow: hidden;
            white-space: nowrap;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.05);
        }

        .alertBar span {
            display: inline-block;
            padding-left: 100%;
            animation: scroll 12s linear infinite;
        }

        @keyframes scroll {
            from { transform: translateX(0); }
            to   { transform: translateX(-100%); }
        }

        .alert-item {
            border-bottom: 1px solid rgba(0, 0, 0, 0.05);
        }

        /* ---------- ITEM CARDS GRID ---------- */
        .items {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(clamp(130px, 28vw, 180px), 1fr));
            gap: clamp(10px, 2.5vw, 20px);
            justify-content: center;
            margin-top: 20px;
        }

        .itemCard {
            background: white;
            padding: clamp(14px, 3vw, 20px);
            border-radius: 15px;
            box-shadow: 0 6px 18px rgba(0, 0, 0, 0.06);
            transition: transform 0.2s, box-shadow 0.2s;
            cursor: pointer;
            border: 2px solid transparent;
        }

        .itemCard:hover {
            transform: translateY(-4px);
            box-shadow: 0 14px 28px rgba(0, 0, 0, 0.1);
        }

        .itemCard.selected {
            border-color: #2d6a4f;
            background-color: #f0fff4;
        }

        .itemCard h3 {
            margin: 8px 0 4px;
            color: #333;
            font-size: clamp(15px, 3.5vw, 18px);
        }

        .itemCard p {
            color: #555;
            font-weight: 500;
            font-size: clamp(14px, 3vw, 16px);
        }

        /* ---------- QUANTITY LIST ---------- */
        #quantityList {
            background: white;
            padding: clamp(16px, 4vw, 30px);
            border-radius: 15px;
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.06);
            display: inline-block;
            text-align: left;
            min-width: 0;
            width: min(100%, 600px);
            max-width: 600px;
        }

        #quantityList input[type="checkbox"] {
            -webkit-appearance: checkbox !important;
            appearance: checkbox !important;
            width: 18px !important;
            height: 18px !important;
            display: inline-block !important;
            opacity: 1 !important;
            visibility: visible !important;
            position: relative !important;
        }

        /* ---------- ADMIN PANEL ---------- */
        .modal {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(5px);
            justify-content: center;
            align-items: center;
            z-index: 1000;
            animation: fadeIn 0.2s;
            padding: 20px;
        }

        .modalBox {
            background: white;
            padding: clamp(20px, 5vw, 30px);
            border-radius: 15px;
            box-shadow: 0 20px 40px rgba(0, 0, 0, 0.2);
            text-align: center;
            width: min(360px, 100%);
        }

        #adminPanel input,
        #adminPanel select {
            margin: 5px;
        }

        /* Admin items list row */
        .adminItemRow {
            display: flex;
            align-items: center;
            gap: 10px;
            flex-wrap: wrap;
            justify-content: center;
            margin: 8px 0;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 8px;
            border: 1px solid #e9ecef;
        }

        .adminItemRow .item-label {
            font-weight: 600;
            font-size: 15px;
            min-width: 100px;
            text-align: left;
            flex: 1;
        }

        .adminItemRow input[type="number"] {
            width: 110px !important;
            margin: 0 !important;
            flex-shrink: 0;
        }

        .adminItemRow .item-type-badge {
            font-size: 11px;
            background: #2d6a4f;
            color: white;
            padding: 2px 8px;
            border-radius: 10px;
            font-weight: 600;
        }

        .btn-delete-item {
            background: #e74c3c !important;
            padding: 7px 14px !important;
            font-size: 12px !important;
            border-radius: 8px !important;
            margin: 0 !important;
            width: auto !important;
        }

        .btn-delete-item:hover {
            background: #c0392b !important;
        }

        /* ---------- INSTALL BANNER ---------- */
        #installBanner {
            display: none;
            position: fixed;
            top: 70px;
            right: 16px;
            width: auto;
            max-width: min(240px, calc(100vw - 32px));
            background: #1e1e1e;
            color: white;
            padding: 12px 14px 10px;
            text-align: center;
            border-radius: 12px;
            z-index: 999;
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.35);
            animation: bannerFadeIn 0.4s ease-out;
        }

        #installBanner::after {
            content: "";
            position: absolute;
            top: -9px;
            right: 22px;
            border-width: 0 9px 9px 9px;
            border-style: solid;
            border-color: transparent transparent #1e1e1e transparent;
        }

        #installBanner button {
            margin-top: 6px;
            margin-bottom: 4px;
            padding: 7px 16px;
            background: #25d366;
            color: white;
            border: none;
            border-radius: 8px;
            font-weight: bold;
            cursor: pointer;
            font-size: 13px;
            width: auto !important;
        }

        #installBanner .close {
            position: absolute;
            top: 4px;
            right: 12px;
            font-size: 20px;
            cursor: pointer;
            color: #aaa;
            line-height: 1;
        }

        @keyframes bannerFadeIn {
            from { opacity: 0; transform: translateY(-8px); }
            to   { opacity: 1; transform: translateY(0);    }
        }

        /* ---------- NAV BAR ---------- */
        #navBar {
            display: none;
            justify-content: flex-end;
            padding: 8px 16px;
            gap: 10px;
            flex-wrap: wrap;
            background: white;
            box-shadow: 0 2px 6px rgba(0,0,0,0.06);
        }

        #navBar button {
            margin: 0;
            font-size: clamp(14px, 3vw, 16px);
            padding: 8px clamp(12px, 2.5vw, 18px);
            width: auto !important;
        }

        /* ---------- RESPONSIVE: TABLET ---------- */
        @media (min-width: 600px) and (max-width: 1024px) {
            .items {
                grid-template-columns: repeat(auto-fill, minmax(160px, 1fr));
            }

            .page {
                padding: 32px 24px;
            }
        }

        /* ---------- RESPONSIVE: MOBILE ---------- */
        @media (max-width: 599px) {
            .page {
                padding: 16px 10px;
            }

            .items {
                grid-template-columns: repeat(2, 1fr);
                gap: 10px;
            }

            #quantityList {
                padding: 14px 10px;
                width: 100%;
            }

            button {
                width: min(100%, 300px);
            }

            #installBanner {
                top: 62px;
                right: 10px;
            }

            .adminItemRow {
                flex-direction: column;
                align-items: flex-start;
            }

            .adminItemRow input[type="number"] {
                width: 100% !important;
            }
        }

        /* ---------- RESPONSIVE: DESKTOP ---------- */
        @media (min-width: 1025px) {
            .items {
                grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            }

            .page {
                padding: 40px 40px;
            }

            button:not(#installBanner button) {
                width: auto;
            }
        }
    </style>

    <!-- Firebase SDK -->
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
</head>

<body>

    <header>
        <h2 ondblclick="openAdmin()">SSB Scrap Collector</h2>
        <div>üìû 6303466495</div>
    </header>

    <div id="installBanner">
        <span class="close" onclick="closeInstall()">&times;</span>
        <p id="installText" style="margin: 0 0 4px; font-size: 13px; line-height: 1.4;">üì≤ Install App for easier access!</p>
        <button id="installBtn" onclick="installApp()">Install App</button>
    </div>

    <div id="navBar">
        <button id="navHome" onclick="showPage('page1')"
            style="background:#95a5a6;">Home</button>
        <button id="navBack" onclick="showPage('page2')"
            style="background:#3498db;">Back</button>
    </div>

    <div id="alertBar" class="alertBar hidden"></div>
    <div id="noteBox" class="noteBox hidden"></div>

    <!-- PAGE 1 -->
    <section id="page1" class="page active">
        <h1>Check Scrap Prices</h1>
        <p>Enter mobile number to view live prices</p>
        <input id="mobile" type="tel" inputmode="numeric" placeholder="Mobile Number" autocomplete="tel">
        <br>
        <button onclick="checkMobile()">Check Prices</button>
    </section>

    <!-- PAGE 2 -->
    <section id="page2" class="page">
        <h1>Select Items</h1>
        <div id="itemsList" class="items"></div>
        <button onclick="goToQuantity()">Next ‚Üí</button>
    </section>

    <!-- PAGE 3 -->
    <section id="page3" class="page">
        <h1>Enter Quantity</h1>
        <div id="quantityList"></div>
        <h2 id="total">Total: ‚Çπ0</h2>

        <div style="margin: 20px 0;">
            <input id="userLocation" placeholder="Enter your full address/location"
                style="width: min(90%, 400px);">
        </div>

        <div class="noteBox" style="margin: 20px auto; max-width: 400px; background:#e8f5e9; border-left:4px solid #2d6a4f; padding:12px; border-radius:6px; text-align:left;">
            üìû 6303466495<br>üìç Marpuristreet, Madanapalli, 517325
        </div>

        <button onclick="sendWhatsApp()">üì§ Send Request</button>
    </section>

    <!-- ADMIN LOGIN MODAL -->
    <div id="adminModal" class="modal">
        <div class="modalBox">
            <h3>üîê Admin Login</h3>
            <input type="email" id="adminEmail" placeholder="Admin Email" autocomplete="email">
            <br>
            <input type="password" id="adminPass" placeholder="Password" autocomplete="current-password">
            <br>
            <p id="loginError" style="color:#e74c3c; font-size:13px; margin:6px 0 0; display:none;"></p>
            <button onclick="checkAdmin()">Login</button>
            <button onclick="document.getElementById('adminModal').style.display='none'"
                style="background:#95a5a6; margin-left:8px;">Cancel</button>
        </div>
    </div>

    <!-- ADMIN PANEL -->
    <section id="adminPanel" class="page">
        <h1>‚öôÔ∏è Admin Dashboard</h1>
        <button onclick="adminLogout()"
            style="background:#e74c3c; float:right; margin-top:0; padding:8px 18px; font-size:13px; width:auto;">Logout</button>
        <div style="clear:both; margin-bottom:10px;"></div>

        <!-- Current Items (edit price + delete) -->
        <h3 style="text-align:left;">üìã Current Items</h3>
        <div id="adminItems"></div>
        <button onclick="savePrices()" style="background:linear-gradient(135deg,#27ae60,#1e8449);">üíæ Save Prices</button>

        <hr>
        <!-- Add new item -->
        <h3>‚ûï Add Item</h3>
        <input id="newItemName" placeholder="Item Name">
        <input id="newItemPrice" placeholder="Price (‚Çπ)" type="number" inputmode="decimal">
        <select id="newItemType">
            <option value="kg">Kg</option>
            <option value="piece">Piece</option>
        </select>
        <br><button onclick="addNewItem()">Add Item</button>

        <hr>
        <!-- Announcements -->
        <h3>üì¢ Add Announcement</h3>
        <input id="alertInput" placeholder="Scrolling alert text" style="width:min(80%,400px);">
        <div style="display:flex; gap:10px; flex-wrap:wrap; justify-content:center; margin:10px 0; padding:10px; background:#f8f9fa; border-radius:8px;">
            <label style="font-size:13px; display:flex; align-items:center; gap:5px;">Text: <input type="color" id="alertColor" value="#000000" style="width:36px; height:28px; padding:2px; border:1px solid #ddd; border-radius:4px; cursor:pointer;"></label>
            <label style="font-size:13px; display:flex; align-items:center; gap:5px;">BG: <input type="color" id="alertBg" value="#fab005" style="width:36px; height:28px; padding:2px; border:1px solid #ddd; border-radius:4px; cursor:pointer;"></label>
            <label style="font-size:13px; display:flex; align-items:center; gap:5px;">Font:
                <select id="alertFont" style="width:auto; margin:0; padding:5px 8px;">
                    <option value="Poppins, sans-serif">Poppins</option>
                    <option value="Arial, sans-serif">Arial</option>
                    <option value="Georgia, serif">Georgia</option>
                    <option value="'Courier New', monospace">Courier New</option>
                </select></label>
            <label style="font-size:13px; display:flex; align-items:center; gap:5px;">Style:
                <select id="alertStyle" style="width:auto; margin:0; padding:5px 8px;">
                    <option value="normal">Normal</option>
                    <option value="bold">Bold</option>
                    <option value="italic">Italic</option>
                    <option value="bold italic">Bold Italic</option>
                </select></label>
        </div>
        <button onclick="addAlert()">Add Alert</button>
        <div id="adminAlertList" style="margin-top:10px; max-height:220px; overflow-y:auto; border:1px solid #eee; border-radius:6px; padding:5px;"></div>

        <hr>
        <!-- Notes -->
        <h3>üìù Add Note</h3>
        <textarea id="noteInput" placeholder="Note text" style="width:min(80%,400px); min-height:80px;"></textarea>
        <div style="display:flex; gap:10px; flex-wrap:wrap; justify-content:center; margin:10px 0; padding:10px; background:#f8f9fa; border-radius:8px;">
            <label style="font-size:13px; display:flex; align-items:center; gap:5px;">Text: <input type="color" id="noteColor" value="#333333" style="width:36px; height:28px; padding:2px; border:1px solid #ddd; border-radius:4px; cursor:pointer;"></label>
            <label style="font-size:13px; display:flex; align-items:center; gap:5px;">BG: <input type="color" id="noteBg" value="#e7f5ff" style="width:36px; height:28px; padding:2px; border:1px solid #ddd; border-radius:4px; cursor:pointer;"></label>
            <label style="font-size:13px; display:flex; align-items:center; gap:5px;">Font:
                <select id="noteFont" style="width:auto; margin:0; padding:5px 8px;">
                    <option value="Poppins, sans-serif">Poppins</option>
                    <option value="Arial, sans-serif">Arial</option>
                    <option value="Georgia, serif">Georgia</option>
                    <option value="'Courier New', monospace">Courier New</option>
                </select></label>
            <label style="font-size:13px; display:flex; align-items:center; gap:5px;">Style:
                <select id="noteStyle" style="width:auto; margin:0; padding:5px 8px;">
                    <option value="normal">Normal</option>
                    <option value="bold">Bold</option>
                    <option value="italic">Italic</option>
                    <option value="bold italic">Bold Italic</option>
                </select></label>
        </div>
        <button onclick="addNote()">Add Note</button>
        <div id="adminNoteList" style="margin-top:10px; max-height:220px; overflow-y:auto; border:1px solid #eee; border-radius:6px; padding:5px;"></div>

        <hr>
        <button onclick="showPage('page1')" style="background:#95a5a6;">‚Üê Return to Home</button>
    </section>

    <script>
        /* ---------- FIREBASE CONFIG ---------- */
        const firebaseConfig = {
            apiKey: "AIzaSyDd1unbueL9VyllBjMBPLZOmo7hSjCVTyY",
            authDomain: "ssb1-cb138.firebaseapp.com",
            databaseURL: "https://ssb1-cb138-default-rtdb.asia-southeast1.firebasedatabase.app",
            projectId: "ssb1-cb138",
            storageBucket: "ssb1-cb138.firebasestorage.app",
            messagingSenderId: "1038194431108",
            appId: "1:1038194431108:web:a4814bd8a984a0c662ded1"
        };
        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();
        const auth = firebase.auth();

        /* ---------- DATA ---------- */
        let items = [
            { name: "Newspaper", price: 12, type: "kg" },
            { name: "Iron", price: 32, type: "kg" },
            { name: "Plastic", price: 18, type: "kg" },
            { name: "Fan", price: 150, type: "piece" }
        ];

        let cachedPrices = localStorage.getItem("scrapPrices");
        if (cachedPrices) items = JSON.parse(cachedPrices);

        let selectedItems = {};

        /* ---------- PAGE CONTROL ---------- */
        function showPage(id) {
            document.querySelectorAll(".page").forEach(p => p.classList.remove("active"));
            document.getElementById(id).classList.add("active");

            let bar = document.getElementById("alertBar");
            let box = document.getElementById("noteBox");
            let nav = document.getElementById("navBar");

            if (!nav) return;
            let backBtn = document.getElementById("navBack");

            if (id === "page1") {
                if (alerts.length > 0) bar.classList.remove("hidden");
                if (notes.length > 0) box.classList.remove("hidden");
                nav.style.display = "none";
            } else {
                bar.classList.add("hidden");
                box.classList.add("hidden");

                if (id === "page2") {
                    nav.style.display = "flex";
                    backBtn.style.display = "none";
                } else if (id === "page3") {
                    nav.style.display = "flex";
                    backBtn.style.display = "block";
                    backBtn.innerText = "‚Üê Select Items";
                    backBtn.onclick = function () { showPage('page2'); };
                } else {
                    // Admin panel ‚Äì hide nav
                    nav.style.display = "none";
                }
            }

            // Scroll to top on page change
            window.scrollTo({ top: 0, behavior: 'smooth' });
        }

        /* ---------- CUSTOMER FLOW ---------- */
        function checkMobile() {
            let m = document.getElementById("mobile").value.trim();
            if (m.length < 10) return alert("Enter a valid 10-digit mobile number");
            loadItems();
            showPage("page2");
        }

        function loadItems() {
            let list = document.getElementById("itemsList");
            list.innerHTML = "";
            items.forEach((item, i) => {
                let isSelected = selectedItems.hasOwnProperty(i);
                let div = document.createElement("div");
                div.className = "itemCard" + (isSelected ? " selected" : "");
                div.onclick = function () { toggleSelection(i); };
                div.innerHTML = `
                    <h3>${item.name}</h3>
                    <p>‚Çπ${item.price}/${item.type}</p>
                    <input type="checkbox" id="chk${i}"
                        onclick="event.stopPropagation(); toggleItem(${i}, this)"
                        ${isSelected ? "checked" : ""}>`;
                list.appendChild(div);
            });
        }

        function toggleSelection(i) {
            let c = document.getElementById("chk" + i);
            c.checked = !c.checked;
            let card = c.parentElement;
            if (c.checked) {
                selectedItems[i] = 0;
                if (card) card.classList.add('selected');
            } else {
                delete selectedItems[i];
                if (card) card.classList.remove('selected');
            }
        }

        function toggleItem(i, c) {
            let card = c.closest('.itemCard');
            if (c.checked) {
                selectedItems[i] = 0;
                if (card) card.classList.add('selected');
            } else {
                delete selectedItems[i];
                if (card) card.classList.remove('selected');
            }
        }

        function goToQuantity() {
            let keys = Object.keys(selectedItems);
            if (keys.length === 0) {
                alert("Please select at least one item.");
                return;
            }
            let box = document.getElementById("quantityList");
            box.innerHTML = "";

            for (let i of keys) {
                let it = items[i];

                let rowDiv = document.createElement("div");
                rowDiv.style.cssText = "margin-bottom:20px; padding-bottom:15px; border-bottom:1px solid #eee;";

                let nameDiv = document.createElement("div");
                nameDiv.style.cssText = "font-weight:700; margin-bottom:10px; color:#1b4332; font-size:clamp(14px,3vw,16px);";
                nameDiv.textContent = it.name + " (" + it.type + ")";
                rowDiv.appendChild(nameDiv);

                let flexDiv = document.createElement("div");
                flexDiv.style.cssText = "display:flex; align-items:center; gap:12px; flex-wrap:wrap;";

                let qtyInput = document.createElement("input");
                qtyInput.type = "number";
                qtyInput.inputMode = "decimal";
                qtyInput.id = "qty" + i;
                qtyInput.placeholder = "Quantity";
                qtyInput.min = "0";
                qtyInput.style.cssText = "width:140px; padding:10px; border:1px solid #ccc; border-radius:8px; font-size:14px; margin:0;";
                qtyInput.oninput = function () { calcTotal(i, this.value); };
                flexDiv.appendChild(qtyInput);

                let checkboxDiv = document.createElement("div");
                checkboxDiv.style.cssText = "display:flex; align-items:center; background:#fff0f0; padding:8px 12px; border-radius:8px; border:1px solid #ffcdd2; cursor:pointer; gap:6px;";

                let checkbox = document.createElement("input");
                checkbox.type = "checkbox";
                checkbox.id = "dk" + i;
                checkbox.style.cssText = "width:18px; height:18px; margin:0; cursor:pointer;";
                checkbox.onchange = function () { toggleDK(i, this); };
                checkboxDiv.appendChild(checkbox);

                let labelSpan = document.createElement("span");
                labelSpan.textContent = "Don't Know";
                labelSpan.style.cssText = "font-size:14px; font-weight:700; color:#e74c3c; user-select:none;";
                checkboxDiv.appendChild(labelSpan);

                checkboxDiv.onclick = function (e) {
                    if (e.target !== checkbox) {
                        checkbox.checked = !checkbox.checked;
                        toggleDK(i, checkbox);
                    }
                };

                flexDiv.appendChild(checkboxDiv);
                rowDiv.appendChild(flexDiv);
                box.appendChild(rowDiv);
            }

            showPage("page3");
        }

        function toggleDK(i, checkbox) {
            let input = document.getElementById("qty" + i);
            if (checkbox.checked) {
                input.value = "";
                input.disabled = true;
                input.style.background = "#f0f0f0";
                selectedItems[i] = "DK";
            } else {
                input.disabled = false;
                input.style.background = "white";
                selectedItems[i] = 0;
            }
            calcTotal();
        }

        function calcTotal(i, v) {
            if (i !== undefined && v !== undefined) {
                selectedItems[i] = parseFloat(v) || 0;
            }
            let total = 0;
            let hasDK = false;
            for (let x in selectedItems) {
                if (selectedItems[x] === "DK") {
                    hasDK = true;
                } else {
                    total += (selectedItems[x] || 0) * items[x].price;
                }
            }
            let totalText = "Total: ‚Çπ" + total.toFixed(2);
            if (hasDK) totalText += " (approx)";
            document.getElementById("total").innerText = totalText;
        }

        function sendWhatsApp() {
            let mobile = document.getElementById("mobile").value.trim();
            let location = document.getElementById("userLocation").value.trim();

            if (!location) {
                alert("Please enter your location/address before sending the request.");
                return;
            }

            let msg = `*SSB Scrap Collector - Pickup Request*\n\n`;
            msg += `*ITEMS LIST:*\n`;
            let hasItems = false;
            for (let i in selectedItems) {
                if (selectedItems[i] === "DK") {
                    msg += `- ${items[i].name}: Quantity Unknown\n`;
                    hasItems = true;
                } else if (selectedItems[i] > 0) {
                    msg += `- ${items[i].name}: ${selectedItems[i]} ${items[i].type}\n`;
                    hasItems = true;
                }
            }

            if (!hasItems) {
                alert("Please enter quantity or select 'Don't Know' for at least one item.");
                return;
            }

            let totalText = document.getElementById("total").innerText;
            msg += `\n*${totalText}*\n\n`;
            msg += `*CUSTOMER DETAILS:*\n`;
            msg += `üì± Mobile: ${mobile}\n`;
            msg += `üìç Location: ${location}\n`;

            window.open(`https://wa.me/916303466495?text=${encodeURIComponent(msg)}`, '_blank');
        }

        /* ---------- ADMIN ---------- */
        function openAdmin() {
            document.getElementById("adminModal").style.display = "flex";
        }

        function checkAdmin() {
            let email = document.getElementById("adminEmail").value.trim();
            let pass = document.getElementById("adminPass").value;
            let errEl = document.getElementById("loginError");
            errEl.style.display = "none";
            if (!email || !pass) {
                errEl.innerText = "Enter email and password.";
                errEl.style.display = "block";
                return;
            }
            auth.signInWithEmailAndPassword(email, pass)
                .then(() => {
                    document.getElementById("adminModal").style.display = "none";
                    document.getElementById("adminEmail").value = "";
                    document.getElementById("adminPass").value = "";
                    loadAdminPanel();
                    showPage("adminPanel");
                })
                .catch((err) => {
                    errEl.innerText = "Login failed: " + err.message;
                    errEl.style.display = "block";
                });
        }

        function adminLogout() {
            auth.signOut().then(() => { showPage("page1"); });
        }

        /* ---- Admin: Load items with price edit + DELETE button ---- */
        function loadAdminPanel() {
            let box = document.getElementById("adminItems");
            box.innerHTML = "";
            items.forEach((it, i) => {
                let row = document.createElement("div");
                row.className = "adminItemRow";
                row.innerHTML = `
                    <span class="item-label">üóÉÔ∏è ${it.name}</span>
                    <span class="item-type-badge">${it.type}</span>
                    <span style="font-size:13px; color:#555;">‚Çπ</span>
                    <input type="number" value="${it.price}" id="p${i}" min="0" step="0.5" style="width:110px; margin:0;">
                    <button class="btn-delete-item" onclick="deleteItem(${i})">üóëÔ∏è Delete</button>
                `;
                box.appendChild(row);
            });
            renderAdminLists();
        }

        function savePrices() {
            items.forEach((it, i) => {
                let el = document.getElementById("p" + i);
                if (el) it.price = parseFloat(el.value) || it.price;
            });
            db.ref('scrapPrices').set(items);
            localStorage.setItem("scrapPrices", JSON.stringify(items));
            // Toast feedback
            showToast("‚úÖ Prices saved!");
        }

        /* ---- NEW: Delete an item from the list ---- */
        function deleteItem(i) {
            if (!confirm(`Delete "${items[i].name}" from the list?`)) return;
            items.splice(i, 1);
            db.ref('scrapPrices').set(items.length > 0 ? items : []);
            localStorage.setItem("scrapPrices", JSON.stringify(items));
            loadAdminPanel();
            showToast("üóëÔ∏è Item deleted.");
        }

        function addNewItem() {
            let n = document.getElementById("newItemName").value.trim();
            let p = document.getElementById("newItemPrice").value;
            let t = document.getElementById("newItemType").value;
            if (!n || !p) return alert("Enter both item name and price.");
            items.push({ name: n, price: parseFloat(p), type: t });
            db.ref('scrapPrices').set(items);
            localStorage.setItem("scrapPrices", JSON.stringify(items));
            document.getElementById("newItemName").value = "";
            document.getElementById("newItemPrice").value = "";
            loadAdminPanel();
            showToast("‚úÖ Item added!");
        }

        /* ---------- TOAST NOTIFICATION ---------- */
        function showToast(msg) {
            let t = document.getElementById("toast");
            if (!t) {
                t = document.createElement("div");
                t.id = "toast";
                t.style.cssText = "position:fixed; bottom:30px; left:50%; transform:translateX(-50%); background:#333; color:#fff; padding:10px 22px; border-radius:22px; font-size:14px; z-index:9999; box-shadow:0 4px 15px rgba(0,0,0,0.3); transition:opacity 0.4s;";
                document.body.appendChild(t);
            }
            t.innerText = msg;
            t.style.opacity = "1";
            t.style.display = "block";
            clearTimeout(t._timer);
            t._timer = setTimeout(() => { t.style.opacity = "0"; setTimeout(() => t.style.display = "none", 400); }, 2200);
        }

        /* ---------- ALERTS & NOTES ---------- */
        let alerts = [];
        let notes = [];

        let cachedAlerts = localStorage.getItem("shopAlerts");
        if (cachedAlerts) alerts = JSON.parse(cachedAlerts);
        let cachedNotes = localStorage.getItem("shopNotes");
        if (cachedNotes) notes = JSON.parse(cachedNotes);

        function addAlert() {
            let txt = document.getElementById("alertInput");
            if (!txt.value.trim()) return;
            let color = document.getElementById("alertColor").value;
            let bg = document.getElementById("alertBg").value;
            let font = document.getElementById("alertFont").value;
            let style = document.getElementById("alertStyle").value;
            alerts.push({ text: txt.value, color, bg, style, font });
            db.ref('shopAlerts').set(alerts);
            localStorage.setItem("shopAlerts", JSON.stringify(alerts));
            txt.value = "";
            document.getElementById("alertColor").value = "#000000";
            document.getElementById("alertBg").value = "#fab005";
            document.getElementById("alertFont").selectedIndex = 0;
            document.getElementById("alertStyle").selectedIndex = 0;
            renderAdminLists();
            showAlerts();
        }

        function addNote() {
            let txt = document.getElementById("noteInput");
            if (!txt.value.trim()) return;
            let color = document.getElementById("noteColor").value;
            let bg = document.getElementById("noteBg").value;
            let font = document.getElementById("noteFont").value;
            let style = document.getElementById("noteStyle").value;
            notes.push({ text: txt.value, color, bg, style, font });
            db.ref('shopNotes').set(notes);
            localStorage.setItem("shopNotes", JSON.stringify(notes));
            txt.value = "";
            document.getElementById("noteColor").value = "#333333";
            document.getElementById("noteBg").value = "#e7f5ff";
            document.getElementById("noteFont").selectedIndex = 0;
            document.getElementById("noteStyle").selectedIndex = 0;
            renderAdminLists();
            showNotes();
        }

        function deleteAlert(i) {
            if (confirm("Delete this alert?")) {
                alerts.splice(i, 1);
                db.ref('shopAlerts').set(alerts);
                localStorage.setItem("shopAlerts", JSON.stringify(alerts));
                renderAdminLists();
                showAlerts();
            }
        }

        function deleteNote(i) {
            if (confirm("Delete this note?")) {
                notes.splice(i, 1);
                db.ref('shopNotes').set(notes);
                localStorage.setItem("shopNotes", JSON.stringify(notes));
                renderAdminLists();
                showNotes();
            }
        }

        function renderAdminLists() {
            let alertList = document.getElementById("adminAlertList");
            alertList.innerHTML = "";
            if (alerts.length === 0) {
                alertList.innerHTML = `<p style="color:#999; font-size:13px; margin:8px;">No alerts yet.</p>`;
            } else {
                alerts.forEach((a, i) => {
                    alertList.innerHTML += `
                    <div style="background:${a.bg}; color:${a.color}; border:1px solid #ccc; margin:5px 0; padding:8px; border-radius:6px; display:flex; justify-content:space-between; align-items:center; gap:8px;">
                        <span style="flex-grow:1; font-size:13px;">${a.text}</span>
                        <button onclick="deleteAlert(${i})" style="background:#e74c3c; margin:0; padding:5px 10px; font-size:12px; width:auto; border-radius:6px;">Delete</button>
                    </div>`;
                });
            }

            let noteList = document.getElementById("adminNoteList");
            noteList.innerHTML = "";
            if (notes.length === 0) {
                noteList.innerHTML = `<p style="color:#999; font-size:13px; margin:8px;">No notes yet.</p>`;
            } else {
                notes.forEach((n, i) => {
                    noteList.innerHTML += `
                    <div style="background:${n.bg}; color:${n.color}; border:1px solid #ccc; margin:5px 0; padding:8px; border-radius:6px; display:flex; justify-content:space-between; align-items:center; gap:8px;">
                        <span style="flex-grow:1; font-size:13px;">${n.text}</span>
                        <button onclick="deleteNote(${i})" style="background:#e74c3c; margin:0; padding:5px 10px; font-size:12px; width:auto; border-radius:6px;">Delete</button>
                    </div>`;
                });
            }
        }

        function showAlerts() {
            let bar = document.getElementById("alertBar");
            bar.innerHTML = "";
            let onPage1 = document.getElementById("page1").classList.contains("active");
            if (alerts.length > 0) {
                if (onPage1) bar.classList.remove("hidden");
                bar.style.padding = "0";
                bar.style.background = "transparent";
                alerts.forEach(a => {
                    let div = document.createElement("div");
                    div.style.background = a.bg;
                    div.style.color = a.color;
                    div.style.padding = "8px 12px";
                    div.style.overflow = "hidden";
                    div.style.whiteSpace = "nowrap";
                    div.style.fontFamily = a.font || "inherit";
                    div.style.fontWeight = (a.style === "bold" || a.style === "bold italic") ? "bold" : "normal";
                    div.style.fontStyle = (a.style === "italic" || a.style === "bold italic") ? "italic" : "normal";
                    div.classList.add("alert-item");
                    div.innerHTML = `<span style="display:inline-block; padding-left:100%; animation:scroll 12s linear infinite;">${a.text}</span>`;
                    bar.appendChild(div);
                });
            } else {
                bar.classList.add("hidden");
            }
        }

        function showNotes() {
            let box = document.getElementById("noteBox");
            if (!box) return;
            box.innerHTML = "";
            box.style.cssText = "background:transparent; border:none; padding:0;";
            let onPage1 = document.getElementById("page1").classList.contains("active");
            if (notes.length > 0) {
                if (onPage1) box.classList.remove("hidden");
                notes.forEach(n => {
                    let div = document.createElement("div");
                    div.style.background = n.bg;
                    div.style.color = n.color;
                    div.style.padding = "10px 14px";
                    div.style.margin = "8px 0";
                    div.style.borderRadius = "6px";
                    div.style.borderLeft = "5px solid #1971c2";
                    div.style.fontFamily = n.font || "inherit";
                    div.style.fontWeight = (n.style === "bold" || n.style === "bold italic") ? "bold" : "normal";
                    div.style.fontStyle = (n.style === "italic" || n.style === "bold italic") ? "italic" : "normal";
                    div.style.fontSize = "clamp(15px, 3vw, 17px)";
                    div.innerText = n.text;
                    box.appendChild(div);
                });
            } else {
                box.classList.add("hidden");
            }
        }

        showAlerts();
        showNotes();

        /* ---------- FIREBASE LIVE LISTENERS ---------- */
        db.ref('scrapPrices').on('value', (snap) => {
            if (snap.exists()) {
                items = snap.val();
                localStorage.setItem("scrapPrices", JSON.stringify(items));
                if (document.getElementById("adminPanel").classList.contains("active")) loadAdminPanel();
                if (document.getElementById("page2").classList.contains("active")) loadItems();
            }
        });

        db.ref('shopAlerts').on('value', (snap) => {
            alerts = snap.exists() ? snap.val() : [];
            localStorage.setItem("shopAlerts", JSON.stringify(alerts));
            showAlerts();
            if (document.getElementById("adminPanel").classList.contains("active")) renderAdminLists();
        });

        db.ref('shopNotes').on('value', (snap) => {
            notes = snap.exists() ? snap.val() : [];
            localStorage.setItem("shopNotes", JSON.stringify(notes));
            showNotes();
            if (document.getElementById("adminPanel").classList.contains("active")) renderAdminLists();
        });

        /* ---------- SERVICE WORKER ---------- */
        if ('serviceWorker' in navigator) {
            navigator.serviceWorker.register('./sw.js')
                .then(() => console.log('SW Registered'))
                .catch((err) => console.log('SW Failed', err));
        }

        /* ---------- PWA INSTALL BANNER ---------- */
        let deferredPrompt;
        const installBanner = document.getElementById("installBanner");
        const installBtn = document.getElementById("installBtn");
        const installText = document.getElementById("installText");

        const isRunningStandalone =
            window.matchMedia('(display-mode: standalone)').matches ||
            window.navigator.standalone === true;

        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;
            if (!isRunningStandalone) {
                installBanner.style.display = "block";
            }
        });

        window.addEventListener('appinstalled', () => {
            installBanner.style.display = "none";
            deferredPrompt = null;
        });

        const isIos = /iphone|ipad|ipod/.test(navigator.userAgent.toLowerCase());
        if (isIos && !isRunningStandalone) {
            installBanner.style.display = "block";
            installText.innerText = "üì≤ Tap Share ‚¨ÜÔ∏è ‚Üí 'Add to Home Screen'";
            installBtn.style.display = "none";
        }

        function installApp() {
            installBanner.style.display = "none";
            if (deferredPrompt) {
                deferredPrompt.prompt();
                deferredPrompt.userChoice.then((result) => {
                    deferredPrompt = null;
                });
            }
        }

        function closeInstall() {
            installBanner.style.display = "none";
        }
    </script>

</body>
</html>
